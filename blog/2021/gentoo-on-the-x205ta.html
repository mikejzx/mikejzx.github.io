<!DOCTYPE html>
<html lang="en">

	<head>
		<!-- Metadata -->
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description" content="Michael Skec's Personal Webpage"/>
		<meta name="keywords" content="mikejzx, skec, michael, mike, blog, site"/>
		<meta name="author" content="Michael Skec"/>
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>

		<!-- RSS feed -->
		<link rel="alternate" type="application/atom+xml" href="/rss.xml"/>

		<!-- Stylesheet -->
		<link rel="stylesheet" href="/css/styles.css" type="text/css"/>

		<!-- Page title -->
		<title>Gentoo on the X205TA &ndash; Mike&rsquo;s Blog</title>
	</head>

	<body>

		<!-- Navbar -->
		<nav>
			<a href="/index.html">home</a>
			<a href="/blog/index.html">writings</a>
			<a href="/rss.xml">rss</a>
		</nav>
		<article>
			<header>
				<span class="sntc">Gentoo on the X205TA</span>
				<span style="float: right">2021-01-14</span>
			</header>
			<p class="sentspc">
				<span class="sntc">I&rsquo;ve had an ASUS X205TA for a few years now, and installed Lubuntu on it initially, as it was practically unusable with Windows&nbsp;10 after installing a few programs.</span>
				<span class="sntc">Lubuntu was great and all for me while I was just starting to use to Linux more often, and it worked fine for doing schoolwork.</span>
				<span class="sntc">Just recently I felt like it was time to do a clean install of something on there.</span>
				<span class="sntc">I was initially thinking of going with Arch, but I figured I&rsquo;d get a bit adventurous and try something different &#40;already running Arch on two other machines&#41;.</span>
				<span class="sntc">I thought, &ldquo;Maybe I should try out Gentoo!&rdquo;</span>
				<span class="sntc">This was my first time installing Gentoo&mdash;it was also probably the most painful Linux install I&rsquo;ve ever put myself through!</span>
				<span class="sntc">&#40;not because of Gentoo, but because of the device hardware&#41;.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">If you&rsquo;ve done any searching online for guides or helpers on installing Gentoo specifically on this laptop, you&rsquo;ve probably realised already that there&rsquo;s almost no information whatsoever.</span>
				<span class="sntc">You can find info for other distros which doesn&rsquo;t all apply since there&rsquo;s so much manual work required in a Gentoo installation.</span>
				<span class="sntc">There&rsquo;s one article by <a href="https://blanktar.jp/blog/2015/02/gentoo-into-eeebook">some Japanese guy</a> which when translated has some useful stuff in it.</span>
				<span class="sntc">The guy was close to getting it to work on his X205TA, but ran into the same issues that I did; kernel panics while booting, and an unusable keyboard when it actually did boot.</span>
				<span class="sntc">After hours of tweaking with the kernel configuration, I managed to get the system to run real nicely.</span>
				<span class="sntc">I still haven&rsquo;t run into any issues, freezes or anything, which is great!</span>
			</p>
			<p class="sentspc">
				<span class="sntc">I thought I&rsquo;d write this little guide to help any of the other people pulling their hair out trying to install Gentoo on this system.</span>
				<span class="sntc">This is not a &ldquo;full installation&rdquo; per se, but rather a set of <b>extra&#47;notable steps</b> that need to be taken on this device.</span>
				<span class="sntc">I&rsquo;d recommend having this guide on the side as you follow the official guide.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">Let me just warn you now&mdash;compilation of large packages on this device will usually take quite a while.</span>
				<span class="sntc">If I were you I&rsquo;d definitely try avoiding installing any massive desktop environments, and instead take a minimal approach, with a standalone window manager, etc.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">Oh, and a little disclaimer: do this at your own risk.</span>
				<span class="sntc">I&rsquo;m not at fault if you screw up your laptop!</span>
			</p>
			<h2>
				<span class="sntc">Getting started</span>
			</h2>
			<p class="sentspc">
				<span class="sntc">If you&rsquo;ve installed Linux on an X205TA before, you&rsquo;re probably already aware that the device has a 64&#45;bit CPU, and must have an exclusively 32&#45;bit bootloader &#40;if you didn&rsquo;t know that before you&rsquo;re probably wondering why this is the case; the reason is actually because ASUS are a pack of idiots&#41;.</span>
				<span class="sntc">Gentoo&rsquo;s Live 64&#45;bit CD ISO already comes with a 32&#45;bit bootloader on it, so you&rsquo;re able to just burn it to a USB stick, plug it in, and boot right into the live environment.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">Wi&#45;fi should work out of the box.</span>
				<span class="sntc">Hop into <code>wpa&#95;supplicant</code> and get yourself connected. If for whatever reason you cannot connect, try run <code>modprobe brcmfmac</code> to manually load the Wi&#45;fi module.</span>
			</p>
			<h2>
				<span class="sntc">Partitioning</span>
			</h2>
			<p class="sentspc">
				<span class="sntc">The X205TA uses an eMMC as it&rsquo;s storage device &#40;basically an SD card&#41;.</span>
				<span class="sntc">Linux identifies it as <code>&#47;dev&#47;mmcblkX</code> and its partitions as <code>&#47;dev&#47;mmcblkpXpX</code>.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">I partitioned my drives as below using <code>parted</code>:</span>
			</p>
			<pre>
NAME          SIZE   MOUNTPOINT
mmcblk1
  mmcblk1p1   130M   &#47;boot&#47;EFI
  mmcblk1p2    29G   &#47;			</pre>
			<p class="sentspc">
				<span class="sntc">Since this is a UEFI system, we need to create an ESP &#40;EFI System Partition&#41;, which is <code>mmcblk1p1</code> in my case.</span>
				<span class="sntc">Make sure you also <b>set the ESP to be bootable!</b></span>
				<span class="sntc">It should have both the &rsquo;boot&rsquo; and &rsquo;esp&rsquo; flags when you run the print command in <code>parted</code>.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">If your <code>lsblk</code> output includes a bunch of other block devices, like <code>mmcblk1boot0</code> or something, just ignore them.</span>
				<span class="sntc">I didn&rsquo;t use these at all and had no idea where they came from honestly.</span>
				<span class="sntc">You might be able to delete them if you want &#40;though I&rsquo;m not sure if it&rsquo;ll cause problems&#41;.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">You can optionally create a separate <code>&#47;boot</code> partition if you want.</span>
				<span class="sntc">I decided not to do this just to keep shit simple.</span>
			</p>
			<p class="sentspc">
				<span class="sntc"><b>Note</b>: the X205TA only has 2 GiB of RAM onboard.</span>
				<span class="sntc"><b>You will need some kind of swap space on the system</b> to compile some of the larger packages or else you will run out of RAM and portage will abort the compilation process &#40;happened to me twice while compiling GCC&#41;.</span>
				<span class="sntc">You can create a swap partition if you like.</span>
				<span class="sntc">I personally created a 2 GiB swapfile, however you can use as much as you like.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">As for filesystems.</span>
				<span class="sntc">The ESP must also be formatted as a FAT filesystem, so:</span>
			</p>
			<pre>
mkfs.fat &#45;F 32 &#47;dev&#47;mmcblk1p1			</pre>
			<p class="sentspc">
				<span class="sntc">You can of course use EXT4 for your root partition.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">Make sure that you mount all the partitions and <code>swapon</code> your swap space when you chroot into the system &#40;use the method provided in the install guide&#41;.</span>
				<span class="sntc">If you&rsquo;re partitioning the same way as me, make sure you use the same mount points I specified above.</span>
			</p>
			<h2>
				<span class="sntc">Setting up the make.conf</span>
			</h2>
			<p class="sentspc">
				<span class="sntc">You should be able to get away with using <code>MAKEOPTS&#61;"&#45;j3"</code> for building most of the packages on the system &#40;be careful when compiling large packages like GCC though.</span>
				<span class="sntc">If you have too many jobs then you will end up writing a lot to swap instead of RAM which will make compilation very slow&#41;.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">Other things you will want to put in your make.conf:</span>
			</p>
			<pre>
&#35; 'synaptics' is for touchpad support
INPUT&#95;DEVICES&#61;"libinput synaptics"
&#35; X205TA has Intel graphics onboard
VIDEO&#95;CARDS&#61;"intel i965"			</pre>
			<p class="sentspc">
				<span class="sntc">You can also add the following CPU flags to it, I generated these using <code>cpuid2cpuflags</code>. If you want to be absolutely certain that these are correct for your hardware, emerge <code>cpuid2cpuflags</code> and run it yourself.</span>
			</p>
			<pre>
CPU&#95;FLAGS&#95;X86&#61;"aes mmx mmxext pclmul popcnt rdrand sse sse2 sse3 sse4&#95;2 ssse3"			</pre>
			<p class="sentspc">
				<span class="sntc">Finally, and this is probably one of the most important settings; like I mentioned earlier, the X205TA has an exclusively 32&#45;bit bootloader.</span>
				<span class="sntc">Make sure you put this in your make.conf if you want your machine to boot:</span>
			</p>
			<pre>
GRUB&#95;PLATFORMS&#61;"efi&#45;32"			</pre>
			<h2>
				<span class="sntc">Kernel configuration</span>
			</h2>
			<p class="sentspc">
				<span class="sntc">Okay.</span>
				<span class="sntc">This is another important part; it&rsquo;s also where it gets pretty messy.</span>
				<span class="sntc">There are a bunch of kernel options that must be included in order for your system to function properly. These should be all the important ones.</span>
				<span class="sntc">If you think anything is missing, feel free to contact me and I&rsquo;ll correct it.</span>
				<span class="sntc">I&rsquo;ve also probably included more options than necessary here&mdash;I don&rsquo;t really have the time to test every option individually, so I just went with whatever worked.</span>
				<span class="sntc">If you think any of the options are completely unnecessary, just let me know and I&rsquo;ll remove it from here.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">If you don&rsquo;t want to configure your kernel yourself &#40;or if you can&rsquo;t get your system to work properly&#41;, you can try <a href="/files/x205ta-kernel.config.gz">using my config instead</a> &#40;no sound support&#41;, given that you are also running something around kernel 5.4.80.</span>
			</p>
			<h3>
				<span class="sntc">eMMC support</span>
			</h3>
			<p class="sentspc">
				<span class="sntc">Make sure you&rsquo;ve got all of these in your config, or else you will get kernel panics at boot time.</span>
			</p>
			<pre>
Device Drivers
  MMC&#47;SD&#47;SDIO card support
    &#60;&#42;&#62; MMC block device driver
    &#60;&#42;&#62; Secure Digital Host Controller Interface support
    &#60;&#42;&#62;   SDHCI support on PCI bus
    &#91;&#42;&#93;     Ricoh MMC Controller Disabler
    &#60;&#42;&#62;   SDHCI support for ACPI enumerated SDHCI controllers
    &#60;&#42;&#62;   SDHCI platform and OF driver helper
    &#60;&#42;&#62; MMC&#47;SD driver for Ricoh Bay1Controllers			</pre>
			<h3>
				<span class="sntc">Pin Controller</span>
			</h3>
			<pre>
Device Drivers
  Pin controllers
    &#91;&#42;&#93; Intel Baytrail GPIO pin control
    &#91;&#42;&#93; Intel Cherryview&#47;Braswell pinctrl and GPIO driver			</pre>
			<h3>
				<span class="sntc">Wi&#45;fi</span>
			</h3>
			<p class="sentspc">
				<span class="sntc">Thanks to the Japanese guy I mentioned earlier for mentioning these options.</span>
				<span class="sntc">However we also need to include the WLAN driver so we can enable the <code>wlan0</code> interface.</span>
				<span class="sntc">&#40;Note that these are in addition to the other base options that you&rsquo;d normally use for networking&#41;.</span>
			</p>
			<pre>
Device Drivers
  Wireless LAN
    &#91;&#42;&#93; Broadcom devices
    &#60;M&#62;   Broadcom 43xx wireless support &#40;mac80211 stack&#41;
    &#91;&#42;&#93;   Broadcom 43xx SDIO device support
    &#60;M&#62;   Broadcom FullMAC WLAN driver
    &#91;&#42;&#93;   SDIO bus interface support for FullMAC driver
Networking Support
  &#60;M&#62; cfg80211 &#45; wireless configuration API
  &#91;&#42;&#93;   enable powersave by default
  &#91;&#42;&#93;   cfg80211 wireless extensions compatibility
  &#60;M&#62; Generic IEEE 802.11 Networking Stack &#40;mac80211&#41;
  &#91;&#42;&#93; Export mac80211 internals in DebugFS			</pre>
			<h3>
				<span class="sntc">Input</span>
			</h3>
			<p class="sentspc">
				<span class="sntc">The following need to be built into the kernel to get the keyboard working.</span>
				<span class="sntc">Thanks to <a href="https://ubuntuforums.org/showthread.php?t=2254322&p=13733677#post13733677">harryharryharry over at Ubuntu forums</a> for mentioning the I2C stuff &#40;and for all of his contributions to getting Linux working on this laptop!&#41;</span>
			</p>
			<pre>
Device Drivers
  HID support
    I2C HID support
      &#60;&#42;&#62; HID over I2C transport layer
  I2C support
    I2C Hardware Bus Support
      &#60;&#42;&#62; Synopsys DesignWare Platform
      &#91;&#42;&#93;   Synopsys DesignWare Slave
      &#60;&#42;&#62; Synopsys DesignWare PCI
      &#91;&#42;&#93; Intel Baytrail I2C semaphore support
  Input device support
    &#60;M&#62; Mouse interface
    &#60;M&#62; Event interface
    &#91;&#42;&#93; Keyboards
    &#60;M&#62;   &#40;basically all keyboards&#41;
    &#91;&#42;&#93; Mice
    &#60;M&#62;   ELAN I2C Touchpad support
    &#91;&#42;&#93;     Enable I2C support
    &#91;&#42;&#93;     Enable SMbus support
    &#60;&#42;&#62;   Synaptics I2C Touchpad support			</pre>
			<h3>
				<span class="sntc">Graphics</span>
			</h3>
			<pre>
Device Drivers
  Graphics support
    &#60;&#42;&#62; Intel 8xx&#47;9xx&#47;G3x&#47;G4x&#47;HD Graphics
    &#91;&#42;&#93; Enable capturing GPU state following a hang.
    &#91;&#42;&#93;   Compress GPU error state
    &#91;&#42;&#93; Always enable userptr support			</pre>
			<h3>
				<span class="sntc">Sound</span>
			</h3>
			<p class="sentspc">
				<span class="sntc">I&rsquo;m adding this section after the original post date &#40;currently 2020&#45;01&#45;22&#41;.</span>
				<span class="sntc">I haven&rsquo;t tried getting sound working on the 5.4 kernel, as I&rsquo;m now running the latest stable 5.10.9 kernel.</span>
				<span class="sntc">You can try reproduce the settings below on an older kernel, I don&rsquo;t know if it&rsquo;ll work though.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">These should be all the options you need to get the sound working decently.</span>
				<span class="sntc">There will be just a slight hiss in the headphone output but I&rsquo;m sure you can live with that.</span>
				<span class="sntc">Oh, and you will also need to manually switch the output from Headphones to Speakers and vice&#45;versa, using e.g. pavucontrol.</span>
				<span class="sntc">You could probably set up some kind of output&#45;toggle binding to speed up that process.</span>
			</p>
			<pre>
Device Drivers
  &#60;&#42;&#62; Sound card support
    &#60;&#42;&#62; ALSA
      &#91;&#42;&#93; PCI sound devices
      &#60;M&#62; HR&#45;timer backend support
          HD&#45;Audio
          &#60;M&#62; HD Audio PCI
          &#91;&#42;&#93; Build hwdep interface for HD&#45;audio driver
          &#91;&#42;&#93; Support initialization patch loading for HD&#45;audio
          &#60;M&#62; Build Realtek HD&#45;audio codec support
          &#60;M&#62; Build Analog devices HD&#45;audio codec support
      &#40;4096&#41; Pre&#45;allocated buffer size for HD&#45;audio driver
      &#60;&#42;&#62; ALSA for SoC audio support
        &#91;&#42;&#93; Intel ASoC SST drivers
        &#60;&#42;&#62;   ACPI HiFi2 &#40;Baytrail, Cherrytrail&#41; Platforms
        &#45;&#42;&#45; Intel Machine Drivers
          &#60;M&#62; &#40;everything&#41;
        &#91;&#42;&#93; Sound Open Firmware Support
          &#60;&#42;&#62; SOF ACPI enumeration support.
          &#91;&#42;&#93; SOF support for Intel audio DSPs
        &#60;M&#62; ASoC Simple sound card support			</pre>
			<p class="sentspc">
				<span class="sntc">I have no idea if the microphone will work with these options.</span>
				<span class="sntc">I don&rsquo;t really care since I don&rsquo;t use the microphone.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">And from here all the other kernel options &#40;USB support, etc&#41; should be pretty generic and obvious.</span>
			</p>
			<h3>
				<span class="sntc">Kernel patches</span>
			</h3>
			<p class="sentspc">
				<span class="sntc">If you want to squeeze as much performance as possible out of your X205TA, you can apply the <a href="http://ck.kolivas.org/patches">linux&#45;ck performance patches</a> to your kernel.</span>
				<span class="sntc">I&rsquo;m running this personally and it seems to just make the system feel a bit snappier overall.</span>
			</p>
			<h2>
				<span class="sntc">GRUB installation</span>
			</h2>
			<p class="sentspc">
				<span class="sntc">To install GRUB we have to run these two commands.</span>
				<span class="sntc">Make sure you <b>do not</b> include a partition number in the <code>grub&#45;install</code> command &#40;e.g. <b>don&rsquo;t use</b> <code>mmcblk1pX</code>&#41; or else your laptop won&rsquo;t boot &#40;at least in my testing&#41;.</span>
				<span class="sntc">As long as the <code>&#47;boot&#47;EFI</code> directory exists &#40;and you&rsquo;ve formatted partitions the same as me&#41;, the below commands will install the bootloader just fine.</span>
			</p>
			<pre>
grub&#45;install &#45;&#45;target&#61;i386&#45;efi &#47;dev&#47;mmcblk1
grub&#45;mkconfig &#45;o &#47;boot&#47;grub&#47;grub.cfg			</pre>
			<p class="sentspc">
				<span class="sntc">Your bootloader should now appear in <code>&#47;boot&#47;EFI&#47;EFI&#47;gentoo</code>. It probably looks weird with the two EFI directories, but it seems to work perfectly like this.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">I also created an initramfs.</span>
				<span class="sntc">I&rsquo;d say you should probably install one of these too on your machine:</span>
			</p>
			<pre>
genkernel &#45;&#45;install &#45;&#45;kernel&#45;config&#61;&#47;usr&#47;src&#47;linux&#47;.config initramfs			</pre>
			<h2>
				<span class="sntc">Finishing up</span>
			</h2>
			<p class="sentspc">
				<span class="sntc">And that&rsquo;s about it!</span>
				<span class="sntc">If all went well&mdash;you followed the official install Gentoo instructions and applied the stuff from this guide, you should hopefully be able to unmount everything, reboot, and boot into a fresh Gentoo installation on your X205TA!</span>
				<span class="sntc">You&rsquo;re on your own from here to decide how the rest of your system will be laid out.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">If you have any questions, comments, or problems with the information here, please feel free to e&#45;mail me via the address on my <a href="https://mikejzx.github.io">homepage</a>.</span>
			</p>
			<p class="sentspc">
				<span class="sntc">Have fun waiting for all your packages to compile ;&#41;</span>
			</p>
		</article>
	</body>
</html>
